<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å­¦å¤§æ•™è‚² | AI å†…å®¹æŒ‡æŒ¥ä¸­å¿ƒ V20 (çº¯å‡€ç‰ˆ)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <!-- Styles -->
    <style>
        body { font-family: 'Noto Sans SC', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        
        .feed-scroll::-webkit-scrollbar, .script-scroll::-webkit-scrollbar { width: 4px; }
        .feed-scroll::-webkit-scrollbar-track, .script-scroll::-webkit-scrollbar-track { background: #1e293b; }
        .feed-scroll::-webkit-scrollbar-thumb, .script-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 2px; }
        .feed-scroll::-webkit-scrollbar-thumb:hover { background: #64748b; }

        .news-item { transition: all 0.2s ease; border-left: 3px solid transparent; }
        .news-item:hover { background-color: #1e293b; border-left-color: #475569; }
        .selected-item { background-color: #1e293b !important; border-left-color: #3b82f6 !important; }

        /* 3:4 Title Card */
        .title-card-wrapper {
            width: 300px; 
            height: 400px;
            position: relative;
            overflow: hidden;
            background-color: #1e293b;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px; 
            flex-shrink: 0;
        }
        
        .title-card-content {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: white;
            position: relative;
            z-index: 10;
        }

        .cursor-blink::after {
            content: 'â–‹';
            animation: blink 1s step-end infinite;
            color: #3b82f6;
            margin-left: 2px;
        }
        @keyframes blink { 50% { opacity: 0; } }

        .bg-gradient-official { background: linear-gradient(135deg, #2563eb, #0f172a); }
        .bg-gradient-holiday { background: linear-gradient(135deg, #ea580c, #431407); }
        .bg-gradient-competitor { background: linear-gradient(135deg, #7c3aed, #312e81); }
        .bg-gradient-school { background: linear-gradient(135deg, #059669, #064e3b); }
        .bg-gradient-art { background: linear-gradient(135deg, #db2777, #831843); }

        .filter-btn {
            font-size: 11px;
            padding: 6px 12px;
            border-radius: 6px;
            transition: all 0.2s;
            border: 1px solid transparent;
            cursor: pointer;
            white-space: nowrap;
        }
        .filter-active {
            background-color: #3b82f6;
            color: white;
            border-color: #2563eb;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }
        .filter-inactive {
            background-color: #1e293b;
            color: #94a3b8;
            border-color: #334155;
        }

        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-spin { animation: spin 1s linear infinite; }
    </style>
</head>
<body class="min-h-screen flex flex-col text-sm bg-[#0f172a]">

    <!-- Navbar -->
    <nav class="bg-slate-900 border-b border-slate-800 shadow-lg z-50 sticky top-0">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="bg-blue-600 rounded p-1.5 shadow-lg shadow-blue-500/20">
                    <i class="fa-solid fa-robot text-white text-lg"></i>
                </div>
                <div>
                    <h1 class="text-base font-bold tracking-wide text-white">XUEDA <span class="text-blue-500">AI</span> BRAIN</h1>
                    <p class="text-[10px] text-slate-400 tracking-wider">V20.0 | Clean Output</p>
                </div>
            </div>
            <div class="flex items-center space-x-2 bg-slate-800 px-2 py-1 rounded-full border border-slate-700">
                <span class="relative flex h-2 w-2">
                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                  <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                </span>
                <span class="text-[10px] text-slate-300" id="liveStatus">Live</span>
            </div>
        </div>
    </nav>

    <!-- Main Workspace -->
    <main class="flex-1 container mx-auto px-4 py-4 flex flex-col lg:grid lg:grid-cols-12 gap-6 pb-20 lg:pb-4">
            
        <!-- LEFT: Intelligence Feed -->
        <div class="lg:col-span-4 bg-slate-800/50 rounded-xl border border-slate-700 flex flex-col h-[500px] lg:h-[750px] overflow-hidden backdrop-blur-sm order-1">
            <div class="p-3 border-b border-slate-700 bg-slate-800 shrink-0">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="font-bold text-slate-200 text-xs uppercase tracking-wider flex items-center">
                        <i class="fa-solid fa-satellite-dish text-blue-500 mr-2"></i> æƒ…æŠ¥ç­›é€‰
                    </h2>
                    <button onclick="refreshFeed()" id="refreshBtn" class="text-[10px] bg-slate-700 hover:bg-slate-600 px-3 py-1.5 rounded text-slate-300 transition flex items-center border border-slate-600">
                        <i class="fa-solid fa-rotate mr-1"></i> åˆ·æ–°
                    </button>
                </div>
                <div class="flex overflow-x-auto gap-2 pb-1 no-scrollbar">
                    <button onclick="applyFilter('all')" id="filter-all" class="filter-btn filter-active">å…¨éƒ¨</button>
                    <!-- Special Art Exam Button -->
                    <button onclick="applyFilter('art')" id="filter-art" class="filter-btn bg-pink-900/30 text-pink-300 border border-pink-700/50 hover:bg-pink-800/50">
                        <i class="fa-solid fa-palette mr-1"></i> è‰ºè€ƒå†²åˆº
                    </button>
                    <button onclick="applyFilter('official')" id="filter-official" class="filter-btn filter-inactive">å®˜æ–¹</button>
                    <button onclick="applyFilter('holiday')" id="filter-holiday" class="filter-btn filter-inactive">å‡æœŸ</button>
                    <button onclick="applyFilter('competitor')" id="filter-competitor" class="filter-btn filter-inactive">åŒè¡Œ</button>
                </div>
            </div>
            <div id="newsFeed" class="flex-1 overflow-y-auto feed-scroll p-2 space-y-2 relative"></div>
            <div id="feedLoading" class="absolute inset-0 bg-slate-900/80 z-20 hidden flex flex-col items-center justify-center backdrop-blur-sm">
                <i class="fa-solid fa-circle-notch text-blue-500 text-2xl loading-spin mb-2"></i>
                <span class="text-xs text-slate-400">æ­£åœ¨åŒæ­¥æ•°æ®...</span>
            </div>
        </div>

        <!-- CENTER: AI Control Panel -->
        <div class="lg:col-span-3 bg-slate-800/50 rounded-xl border border-slate-700 p-4 flex flex-col h-auto lg:h-[750px] backdrop-blur-sm order-2">
            <h2 class="font-bold text-slate-200 mb-4 text-xs uppercase tracking-wider"><i class="fa-solid fa-microchip text-purple-500 mr-2"></i> æ–‡æ¡ˆç­–ç•¥å¼•æ“</h2>

            <div class="space-y-4 lg:flex-1">
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">AI äººè®¾é€‰æ‹© (Dual-Core)</label>
                    <div class="grid grid-cols-1 gap-2">
                        <!-- Professional -->
                        <label class="cursor-pointer border border-slate-600 bg-slate-800/50 rounded-lg p-3 flex items-center transition relative hover:border-blue-500 group" id="label-professional">
                            <input type="radio" name="persona" value="professional" class="absolute opacity-0" checked onchange="updateConfig()">
                            <div class="w-8 h-8 rounded bg-blue-900/50 text-blue-400 flex items-center justify-center mr-3 border border-blue-800"><i class="fa-solid fa-chart-pie"></i></div>
                            <div>
                                <div class="font-bold text-slate-200 text-xs group-hover:text-blue-400">å‡å­¦æ•°æ®ä¸“å®¶</div>
                                <div class="text-[10px] text-slate-500">æ”¿ç­–æ‹†è§£ | å½•å–åˆ†æ</div>
                            </div>
                            <i class="fa-solid fa-circle-check text-blue-500 absolute top-3 right-3 check-icon opacity-100 transition-opacity duration-200"></i>
                        </label>

                        <!-- Planner -->
                        <label class="cursor-pointer border border-slate-600 bg-slate-800/50 rounded-lg p-3 flex items-center transition relative hover:border-pink-500 group" id="label-teacher">
                            <input type="radio" name="persona" value="teacher" class="absolute opacity-0" onchange="updateConfig()">
                            <div class="w-8 h-8 rounded bg-pink-900/50 text-pink-400 flex items-center justify-center mr-3 border border-pink-800"><i class="fa-solid fa-user-graduate"></i></div>
                            <div>
                                <div class="font-bold text-slate-200 text-xs group-hover:text-pink-400">è´´å¿ƒå¤‡è€ƒå­¦å§</div>
                                <div class="text-[10px] text-slate-500">ç»éªŒåˆ†äº« | é¿å‘æŒ‡å—</div>
                            </div>
                            <i class="fa-regular fa-circle text-slate-600 absolute top-3 right-3 check-icon opacity-100 transition-opacity duration-200"></i>
                        </label>
                    </div>
                </div>

                <div class="bg-black/30 p-3 rounded border border-slate-700 font-mono text-[10px] text-green-400 h-24 lg:h-40 overflow-y-auto">
                    <p>> AI Kernel: V20.0</p>
                    <p>> Output Filter: No Asterisks (*).</p>
                    <p>> Time Sync: Auto.</p>
                    <p id="consoleLog" class="animate-pulse">> Ready.</p>
                </div>
            </div>

            <button id="generateBtn" onclick="startGeneration()" disabled class="w-full py-3 bg-slate-700 text-slate-400 font-bold rounded-lg transition mt-4 flex items-center justify-center text-sm shadow-sm cursor-not-allowed border border-slate-600">
                <span>è¯·å…ˆé€‰æ‹©å·¦ä¾§èµ„è®¯</span>
            </button>
        </div>

        <!-- RIGHT: Output -->
        <div class="lg:col-span-5 bg-slate-800/50 rounded-xl border border-slate-700 flex flex-col h-[600px] lg:h-[750px] overflow-hidden backdrop-blur-sm order-3">
            <div class="flex bg-slate-800 border-b border-slate-700 shrink-0">
                <button class="flex-1 py-3 text-xs font-bold text-blue-400 border-b-2 border-blue-500 bg-slate-700/50" onclick="switchTab('script')"><i class="fa-solid fa-file-code mr-1"></i> æ–‡æ¡ˆ</button>
                <button class="flex-1 py-3 text-xs font-medium text-slate-400 hover:text-slate-200" onclick="switchTab('cover')"><i class="fa-solid fa-image mr-1"></i> å°é¢</button>
            </div>

            <div id="resultArea" class="flex-1 overflow-hidden relative flex flex-col">
                <div id="scriptView" class="p-4 space-y-4 flex-1 overflow-y-auto script-scroll">
                    <div>
                        <div class="flex justify-between items-center mb-1.5">
                            <span class="text-[10px] font-bold text-blue-400 uppercase">çŸ­è§†é¢‘è„šæœ¬</span>
                            <span id="videoStatus" class="text-[10px] text-slate-500">Wait</span>
                        </div>
                        <div id="shortScriptOutput" class="w-full min-h-[100px] bg-black/40 p-3 rounded border border-slate-700 text-sm text-slate-300 font-mono whitespace-pre-wrap leading-relaxed"></div>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-1.5">
                            <span class="text-[10px] font-bold text-red-400 uppercase">å°çº¢ä¹¦ç¬”è®° (çº¯å‡€ç‰ˆ)</span>
                            <span id="xhsStatus" class="text-[10px] text-slate-500">Wait</span>
                        </div>
                        <div id="xhsScriptOutput" class="w-full min-h-[150px] bg-black/40 p-3 rounded border border-slate-700 text-sm text-slate-300 font-sans whitespace-pre-wrap leading-relaxed"></div>
                    </div>
                </div>

                <div id="coverView" class="hidden h-full flex flex-col items-center bg-slate-900 p-0 overflow-y-auto">
                    <div class="flex-shrink-0 w-full p-4 flex justify-center bg-slate-900">
                        <div id="captureTarget" class="title-card-wrapper bg-gradient-official transform transition shadow-2xl">
                            <div class="title-card-content">
                                <div class="flex justify-center w-full mb-6">
                                    <div class="border border-white/40 px-4 py-1.5 rounded-full text-[12px] font-bold uppercase tracking-widest bg-white/10 backdrop-blur-sm shadow-sm mx-auto">
                                        <span id="coverTag">TAG</span>
                                    </div>
                                </div>
                                <h1 id="coverTitle" class="text-2xl md:text-3xl font-black leading-snug drop-shadow-xl mb-8 w-full px-2 text-center break-words whitespace-normal">
                                    ç‚¹å‡»ç”Ÿæˆé¢„è§ˆ
                                </h1>
                                <div class="w-16 h-1.5 bg-white/30 rounded-full mb-2 mx-auto"></div>
                                <div class="w-8 h-1.5 bg-white/30 rounded-full mx-auto"></div>
                                <i class="fa-solid fa-quote-left absolute top-6 left-6 text-4xl opacity-10"></i>
                                <i class="fa-solid fa-quote-right absolute bottom-6 right-6 text-4xl opacity-10"></i>
                            </div>
                        </div>
                    </div>
                    <div class="w-full bg-slate-800 border-t border-slate-700 p-4 shrink-0 mt-auto">
                        <div class="grid grid-cols-1 gap-3 mb-3">
                            <input type="text" id="editTagInput" placeholder="ç¼–è¾‘æ ‡ç­¾" class="w-full bg-slate-700 border border-slate-600 rounded px-3 py-2 text-xs text-white focus:border-blue-500 outline-none" oninput="updateCoverPreview()">
                            <input type="text" id="editTitleInput" placeholder="ç¼–è¾‘ä¸»æ ‡é¢˜ (å®æ—¶é¢„è§ˆ)" class="w-full bg-slate-700 border border-slate-600 rounded px-3 py-2 text-xs text-white focus:border-blue-500 outline-none" oninput="updateCoverPreview()">
                        </div>
                        <button onclick="downloadCover()" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-lg text-xs font-bold transition flex items-center justify-center">
                            <i class="fa-solid fa-download mr-2"></i> ä¿å­˜å°é¢å›¾
                        </button>
                    </div>
                </div>

                <div class="p-3 bg-slate-800 border-t border-slate-700 grid grid-cols-2 gap-2 shrink-0" id="scriptDownloads">
                    <button onclick="downloadMarkdown('video')" class="bg-slate-700 hover:bg-slate-600 text-slate-300 py-3 rounded-lg text-xs font-bold transition flex flex-col items-center justify-center border border-slate-600">
                        <i class="fa-brands fa-markdown text-lg mb-1 group-hover:text-blue-400"></i> è§†é¢‘è„šæœ¬
                    </button>
                    <button onclick="downloadMarkdown('xhs')" class="bg-slate-700 hover:bg-slate-600 text-slate-300 py-3 rounded-lg text-xs font-bold transition flex flex-col items-center justify-center border border-slate-600">
                        <i class="fa-brands fa-markdown text-lg mb-1 group-hover:text-red-400"></i> çº¢ä¹¦æ–‡æ¡ˆ
                    </button>
                </div>
            </div>
        </div>

    </main>

    <script>
        // --- 1. DYNAMIC DATA KERNEL ---
        // Dynamically generating dates relative to "Now"
        const now = new Date();
        const getDateStr = (offsetDays) => {
            const d = new Date(now);
            d.setDate(d.getDate() - offsetDays);
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        };

        const db = [
            // ART EXAM FOCUS
            { id: 'a1', type: 'art', tag: 'è‰ºè€ƒç»“æŸ', source: 'å¹¿ä¸œçœæ•™è‚²è€ƒè¯•é™¢', title: '2026å¹¿ä¸œç¾æœ¯/ä¹¦æ³•/è¡¨å¯¼ç±»ç»Ÿè€ƒç¬”è¯•é¡ºåˆ©ç»“æŸ', date: getDateStr(1), content: 'å…¨çœç»Ÿè€ƒç¬”è¯•ç¯èŠ‚å·²è½å¹•ï¼Œè¯„å·å·¥ä½œå¯åŠ¨ã€‚ä¸‹ä¸€æ­¥é‡å¿ƒå°†å…¨é¢è½¬å‘æ–‡åŒ–è¯¾å¤‡è€ƒï¼Œæ–‡åŒ–åˆ†å æ¯”åœ¨ç»¼åˆåˆ†ä¸­ä¾ç„¶å…³é”®ã€‚', bg: 'bg-gradient-art', link: 'https://eea.gd.gov.cn/' },
            { id: 'a2', type: 'art', tag: 'å½•å–è§„åˆ™', source: 'é˜³å…‰é«˜è€ƒç½‘', title: '2026å¹´è‰ºæœ¯ç±»ä¸“ä¸šå½•å–æ–‡åŒ–è¯¾å æ¯”å†è§£è¯»', date: getDateStr(2), content: 'æ ¹æ®æœ€æ–°æ”¿ç­–ï¼ŒéŸ³ä¹ã€èˆè¹ˆã€ç¾æœ¯ç±»æ–‡åŒ–è¯¾å æ¯”50%ï¼Œæ’­éŸ³ç±»å æ¯”60%ã€‚ä¸“ä¸šè¿‡çº¿åªæ˜¯é—¨æ§›ï¼Œæ–‡åŒ–åˆ†å†³å®šæœ€ç»ˆå½•å–é™¢æ ¡æ¡£æ¬¡ã€‚', bg: 'bg-gradient-art', link: 'https://gaokao.chsi.com.cn/' },
            { id: 'a3', type: 'art', tag: 'æ–‡åŒ–è¯¾', source: 'å­¦å¤§æ•™è‚²ç ”ç©¶é™¢', title: 'è‰ºè€ƒç”Ÿæ–‡åŒ–è¯¾ç™¾æ—¥å†²åˆºå¤ä¹ è§„åˆ’æŒ‡å¼•', date: getDateStr(0), content: 'ç»Ÿè€ƒç»“æŸåï¼Œè‰ºè€ƒç”Ÿé¢ä¸´â€œæ—¶é—´ç´§ã€ä»»åŠ¡é‡ã€åŸºç¡€å¼±â€ä¸‰å¤§æŒ‘æˆ˜ã€‚å»ºè®®ç«‹å³å›å½’è¯¾æœ¬ï¼Œä¸»æŠ“åŸºç¡€åˆ†ã€‚', bg: 'bg-gradient-art', link: '#' },

            // OFFICIAL
            { id: 'o1', type: 'official', tag: 'ç ”è€ƒæé†’', source: 'å¹¿ä¸œçœæ•™è‚²è€ƒè¯•é™¢', title: '2025å¹´ç ”è€ƒè€ƒç‚¹æŸ¥è¯¢åŠæ‰“å°å‡†è€ƒè¯é€šçŸ¥', date: getDateStr(0), content: 'è€ƒç”Ÿå³æ—¥èµ·å¯ç™»å½•ç³»ç»Ÿä¸‹è½½æ‰“å°å‡†è€ƒè¯ã€‚', bg: 'bg-gradient-official', link: 'https://eea.gd.gov.cn/' },
            
            // HOLIDAY
            { id: 'h1', type: 'holiday', tag: 'å¯’å‡é€šçŸ¥', source: 'å¹¿å·å¸‚æ•™è‚²å±€', title: 'å¹¿å·å¸‚ä¸­å°å­¦2026å¹´å¯’å‡æ”¾å‡æ—¶é—´é€šçŸ¥', date: getDateStr(1), content: 'ä¹‰åŠ¡æ•™è‚²é˜¶æ®µ1æœˆ19æ—¥æ”¾å‡ï¼Œé«˜ä¸­1æœˆ23æ—¥æ”¾å‡ã€‚', bg: 'bg-gradient-holiday', link: 'http://k.sina.com.cn/' },
            
            // COMPETITOR
            { id: 'c1', type: 'competitor', tag: 'æ–‡åŒ–è¥', source: 'å“è¶Šæ•™è‚²', title: 'è‰ºè€ƒæ–‡åŒ–è¯¾å…¨æ—¥åˆ¶é›†è®­è¥å¼€è¥', date: getDateStr(2), content: 'ä¸»æ‰“å°ç­æ•™å­¦å’Œå…¨å°é—­ç®¡ç†ï¼ŒæŠ¢è·‘æ–‡åŒ–è¯¾å¤ä¹ é»„é‡‘æœŸã€‚', bg: 'bg-gradient-competitor', link: 'https://www.zy.com/' },
            { id: 'c2', type: 'competitor', tag: 'æ˜¥å­£è¯¾', source: 'å¹¿å·æ–°ä¸œæ–¹', title: '2026æ˜¥å­£ç­è¯¾è¡¨å‘å¸ƒï¼Œæ–°å¢é«˜ä¸­å®éªŒç­', date: getDateStr(3), content: 'å‘å¸ƒæ˜¥å­£è¯¾ç¨‹ä½“ç³»ï¼Œé‡ç‚¹å¼ºåŒ–é«˜ä¸­ç‰©ç†/å†å²æ–¹å‘çš„å®éªŒç­å‹ã€‚', bg: 'bg-gradient-competitor', link: 'https://gz.xdf.cn/' },
            
            // SCHOOL
            { id: 's1', type: 'school', tag: 'è‡ªæ‹›å…¬ç¤º', source: 'æ·±åœ³ä¸­å­¦', title: 'æ·±åœ³ä¸­å­¦2026å¹´ä¸€ç±»è‡ªä¸»æ‹›ç”Ÿæ–¹æ¡ˆå…¬ç¤º', date: getDateStr(4), content: 'æ‹Ÿæ‹›æ”¶æ•°ç†ç‰¹é•¿ç”Ÿ80äººï¼ŒæŠ¥åé€šé“å°†äº12æœˆ20æ—¥å¼€å¯ã€‚', bg: 'bg-gradient-school', link: 'https://www.shenzhong.net/' }
        ];

        document.getElementById('liveStatus').innerText = `Live: ${getDateStr(0)}`;

        let currentFilter = 'all';
        let displayData = [];
        let selectedId = null;
        let config = { persona: 'professional' };

        window.onload = function() { applyFilter('all'); };

        function applyFilter(category) {
            currentFilter = category;
            
            // 1. Reset Selection State immediately when filtering
            selectedId = null;
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('generateBtn').className = "w-full py-3 bg-slate-700 text-slate-400 font-bold rounded-lg transition mt-4 flex items-center justify-center text-sm shadow-sm cursor-not-allowed border border-slate-600";
            document.getElementById('generateBtn').innerHTML = "<span>è¯·å…ˆé€‰æ‹©å·¦ä¾§èµ„è®¯</span>";
            document.getElementById('consoleLog').innerHTML += `<br>> Filter: ${category}. Reset.`;

            // UI Reset
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if(btn.id === 'filter-art') {
                    btn.classList.remove('ring-2', 'ring-pink-500');
                } else {
                    btn.classList.remove('filter-active');
                    btn.classList.add('filter-inactive');
                }
            });

            if(category === 'art') {
                document.getElementById('filter-art').classList.add('ring-2', 'ring-pink-500');
            } else {
                document.getElementById(`filter-${category}`).classList.add('filter-active');
                document.getElementById(`filter-${category}`).classList.remove('filter-inactive');
            }
            
            refreshFeed();
        }

        function refreshFeed() {
            const loading = document.getElementById('feedLoading');
            loading.classList.remove('hidden');
            setTimeout(() => {
                let filtered = currentFilter === 'all' ? db : db.filter(item => item.type === currentFilter);
                filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
                displayData = filtered;
                renderFeed(displayData);
                loading.classList.add('hidden');
            }, 600);
        }

        function renderFeed(data) {
            const container = document.getElementById('newsFeed');
            container.innerHTML = '';
            if (data.length === 0) { container.innerHTML = `<div class="text-center text-slate-500 py-10 text-xs">æš‚æ— æ•°æ®</div>`; return; }

            data.forEach(item => {
                const icons = { official: 'fa-building-columns text-blue-400', holiday: 'fa-umbrella-beach text-orange-400', competitor: 'fa-eye text-purple-400', school: 'fa-school text-emerald-400', art: 'fa-palette text-pink-400' };
                const iconClass = icons[item.type] || 'fa-rss';
                const isSearchLink = item.link.includes('baidu.com');
                const linkIcon = isSearchLink ? 'fa-magnifying-glass' : 'fa-arrow-up-right-from-square';
                const linkText = isSearchLink ? 'éªŒè¯' : 'åŸæ–‡';

                // Helper to format date
                const itemDate = new Date(item.date);
                const today = new Date();
                const diffTime = Math.abs(today - itemDate);
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)); 
                let timeStr = item.date.substr(5);
                if(diffDays === 0) timeStr = "ä»Šå¤©";
                else if(diffDays === 1) timeStr = "æ˜¨å¤©";

                const div = document.createElement('div');
                div.className = `p-3 rounded-lg bg-slate-800 border border-slate-700 hover:border-blue-500 cursor-pointer news-item flex gap-3 mb-2`;
                div.onclick = (e) => { if(!e.target.closest('a')) selectItem(item.id, div); };
                
                div.innerHTML = `
                    <div class="w-12 h-12 rounded bg-slate-700/50 flex flex-col items-center justify-center shrink-0 border border-slate-600">
                        <i class="fa-solid ${iconClass} text-sm"></i>
                    </div>
                    <div class="flex-1 min-w-0 flex flex-col justify-center">
                        <div class="flex justify-between items-start">
                             <h4 class="text-xs font-medium text-slate-200 leading-snug truncate w-[70%]">${item.title}</h4>
                             <span class="text-[9px] text-slate-500">${timeStr}</span>
                        </div>
                        <div class="flex justify-between items-center text-[10px] text-slate-500 mt-1">
                            <span class="bg-slate-700 px-1.5 rounded text-slate-400">${item.tag}</span>
                            <a href="${item.link}" target="_blank" class="flex items-center gap-1 text-blue-400 hover:text-blue-300 transition px-2 py-0.5 rounded hover:bg-slate-700 border border-transparent hover:border-blue-500/30">
                                <i class="fa-solid ${linkIcon} text-[9px]"></i>
                                <span class="font-medium">${linkText}</span>
                            </a>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function selectItem(id, el) {
            document.querySelectorAll('.news-item').forEach(i => { i.classList.remove('selected-item'); i.style.borderColor = '#334155'; });
            el.classList.add('selected-item');
            selectedId = id;
            
            const btn = document.getElementById('generateBtn');
            btn.disabled = false;
            btn.className = "w-full py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg transition mt-4 flex items-center justify-center text-sm shadow-lg shadow-blue-900/20 cursor-pointer";
            btn.innerHTML = "<span><i class='fa-solid fa-sparkles mr-2'></i> ç«‹å³ç”Ÿæˆ</span>";
            
            document.getElementById('consoleLog').innerHTML += `<br>> Selected: ${id}`;
        }

        function updateConfig() {
            const els = document.getElementsByName('persona');
            for(let el of els) if(el.checked) config.persona = el.value;
            
            document.getElementById('label-professional').classList.toggle('border-blue-500', config.persona === 'professional');
            document.getElementById('label-teacher').classList.toggle('border-pink-500', config.persona === 'teacher');
            
            if (selectedId) startGeneration(true);
        }

        function updateCoverPreview() {
            const tagVal = document.getElementById('editTagInput').value;
            const titleVal = document.getElementById('editTitleInput').value;
            if(tagVal) document.getElementById('coverTag').innerText = tagVal;
            if(titleVal) document.getElementById('coverTitle').innerText = titleVal;
        }

        async function startGeneration(fastMode = false) {
            if(!selectedId) return;
            const btn = document.getElementById('generateBtn');
            btn.disabled = true;
            btn.innerHTML = '<span><i class="fa-solid fa-circle-notch fa-spin mr-2"></i> ç”Ÿæˆä¸­...</span>';
            
            const shortOutput = document.getElementById('shortScriptOutput');
            const xhsOutput = document.getElementById('xhsScriptOutput');
            shortOutput.innerHTML = ''; xhsOutput.innerHTML = '';

            const data = displayData.find(d => d.id === selectedId);
            const isArt = data.type === 'art';
            const isCompetitor = data.type === 'competitor';
            
            // --- ALGORITHM 1: PROFESSIONAL ---
            let professionalShort = '';
            if (isArt) {
                professionalShort = `ã€${data.tag}ã€‘è‰ºè€ƒç»Ÿè€ƒç¬”è¯•ç»“æŸï¼Œæ¥ä¸‹æ¥çš„é‡å¿ƒå¿…é¡»è°ƒæ•´ã€‚\n\næ ¹æ®2026å½•å–è§„åˆ™ï¼Œæ–‡åŒ–è¯¾å æ¯”é«˜è¾¾50%ä»¥ä¸Šã€‚ä¸“ä¸šè¿‡çº¿ä»…ä»…æ˜¯å¼€å§‹ï¼Œæ–‡åŒ–åˆ†æ‰æ˜¯å†³èƒœå…³é”®ã€‚\n\nå»ºè®®è€ƒç”Ÿï¼šç«‹åˆ»è¿›è¡ŒçŸ¥è¯†ç‚¹æ–­å±‚æ‰«æï¼Œåˆ¶å®šç™¾æ—¥å†²åˆºè®¡åˆ’ï¼Œåˆ©ç”¨è¿™æ®µé»„é‡‘çª—å£æœŸæŠ¢å›æ–‡åŒ–åˆ†ã€‚`;
            } else if (isCompetitor) {
                professionalShort = `ã€è¡Œä¸šè§‚å¯Ÿã€‘è¿‘æœŸ${data.source}å‘å¸ƒ${data.tag}åŠ¨æ€ã€‚è¿™æŠ˜å°„å‡ºå¤‡è€ƒæ–°é£å‘ï¼š${data.content}ã€‚\n\nå»ºè®®å®¶é•¿é€è¿‡ç°è±¡çœ‹æœ¬è´¨ï¼Œå›å½’æ ¡å†…åŸºç¡€ï¼Œç»“åˆå­©å­å®é™…æƒ…å†µåˆ¶å®šå·®å¼‚åŒ–ç­–ç•¥ï¼Œä¸ç›²ç›®è·Ÿé£ã€‚`;
            } else {
                professionalShort = `ã€${data.tag}ã€‘æœ€æ–°å®˜æ–¹é€šæŠ¥\n\næ®${data.source}å‘å¸ƒçš„æ¶ˆæ¯ï¼š${data.content}ã€‚\n\nè¿™ä¸€åŠ¨æ€ç›´æ¥å½±å“æ¥ä¸‹æ¥çš„å¤‡è€ƒèŠ‚å¥ã€‚è¯·å®¶é•¿åŠ¡å¿…ç™»å½•å®˜ç½‘æ ¸å¯¹å…·ä½“ç»†èŠ‚ï¼Œé¿å…å› ä¿¡æ¯ä¸å¯¹ç§°é€ æˆå¤±è¯¯ã€‚`;
            }

            // CLEAN XHS FORMAT (REMOVED *)
            let professionalXhs = '';
            if (isArt) {
                professionalXhs = `ğŸ“Š æ•°æ®è¯´è¯ | è‰ºè€ƒåæ–‡åŒ–è¯¾æ€ä¹ˆæï¼Ÿ\n\n${data.source}æœ€æ–°æ¶ˆæ¯ï¼š${data.content}\n\nå¾ˆå¤šåŒå­¦è§‰å¾—ä¸“ä¸šè€ƒå®Œå°±ç¨³äº†ï¼ŸâŒ å¤§é”™ç‰¹é”™ï¼\n\n1ï¸âƒ£ å½•å–å…¬å¼æ‹†è§£\nç»¼åˆåˆ† = æ–‡åŒ–åˆ†Ã—50% + ä¸“ä¸šåˆ†Ã—2.5Ã—50%ã€‚è¿™æ„å‘³ç€ï¼šæ–‡åŒ–è¯¾æ¯æ1åˆ†ï¼Œç›¸å½“äºä¸“ä¸šè¯¾è¦æ2.5åˆ†ï¼éš¾åº¦å¯æƒ³è€ŒçŸ¥ã€‚\n\n2ï¸âƒ£ ç°çŠ¶åˆ†æ\nç»Ÿè€ƒç»“æŸåˆ°é«˜è€ƒä»…å‰©ä¸åˆ°6ä¸ªæœˆï¼Œé™¤å»æ ¡è€ƒã€æ˜¥èŠ‚ï¼Œæœ‰æ•ˆå¤ä¹ æ—¶é—´ä¸è¶³100å¤©ã€‚\n\n3ï¸âƒ£ è¡ŒåŠ¨æ¸…å•\nâœ… è‹±è¯­/è¯­æ–‡ï¼šèƒŒå•è¯ã€èƒŒå¤è¯—ï¼ŒæŠ“åŸºç¡€åˆ†\nâœ… æ•°å­¦/æ–‡ç»¼ï¼šæ”¾å¼ƒéš¾é¢˜ï¼Œæ­»ç£•ä¸­ä½æ¡£é¢˜\n\nå…³æ³¨æˆ‘ä»¬ï¼Œè·å–ã€Šè‰ºè€ƒç”Ÿæ–‡åŒ–è¯¾æåˆ†è§„åˆ’è¡¨ã€‹ã€‚\n\n#è‰ºè€ƒ #æ–‡åŒ–è¯¾å†²åˆº #å¹¿ä¸œè‰ºè€ƒ #å‡å­¦è§„åˆ’`;
            } else {
                professionalXhs = `ğŸ“¢ æ”¿ç­–é€Ÿé€’ | ${data.title}\n\n${data.source}å‘å¸ƒæœ€æ–°åŠ¨æ€ï¼Œæ ¸å¿ƒè¦ç‚¹å¦‚ä¸‹ï¼š\n\n1ï¸âƒ£ æ ¸å¿ƒäº‹å®\n${data.content}\n\n2ï¸âƒ£ æ·±åº¦è§£è¯»\n${isCompetitor ? 'è¡Œä¸šåŠ¨ä½œé¢‘é¢‘ï¼Œåæ˜ å‡ºå¸‚åœºå¯¹è¯¥é˜¶æ®µé‡è§†ç¨‹åº¦æå‡ã€‚' : 'æ”¿ç­–è½åœ°ï¼Œæ ‡å¿—ç€æ‹›è€ƒå·¥ä½œæ­£å¼å¯åŠ¨ã€‚'}\n\n3ï¸âƒ£ è¡ŒåŠ¨å»ºè®®\nâœ… å»ºç«‹æ—¶é—´è½´ï¼Œå€’æ¨å¤ä¹ è¿›åº¦\nâœ… æŸ¥æ¼è¡¥ç¼ºï¼Œå…³æ³¨å®˜æ–¹åç»­é€šçŸ¥\n\nç†æ™ºè§„åˆ’ï¼Œä»å®¹åº”å¯¹ã€‚\n\n#å­¦å¤§æ•™è‚² #å‡å­¦è§„åˆ’ #${data.tag}`;
            }

            // --- ALGORITHM 2: PLANNER ---
            let teacherShort = '';
            if (isArt) {
                teacherShort = `è‰ºè€ƒç”Ÿæ³¨æ„ï¼ç»Ÿè€ƒç»“æŸåƒä¸‡åˆ«"èººå¹³"ï¼ğŸ˜°\n\nä½ çŸ¥é“å—ï¼Ÿç°åœ¨æ˜¯æ–‡åŒ–è¯¾å¼¯é“è¶…è½¦çš„æœ€ä½³æ—¶æœºï¼\n\nå¬å­¦å§ä¸€å¥åŠï¼šè¶ç€æ ¡è€ƒå‰çš„ç©ºçª—æœŸï¼ŒæŠŠè‹±è¯­å’Œè¯­æ–‡çš„åŸºç¡€åˆ†æ¡èµ·æ¥ï¼åˆ«è®©æ–‡åŒ–è¯¾æˆä¸ºä½ çš„é—æ†¾ã€‚ä¸æ‡‚æ€ä¹ˆè¡¥çš„ï¼Œè¯„è®ºåŒºé—®æˆ‘ï¼`;
            } else if (isCompetitor) {
                teacherShort = `æœ€è¿‘å®¶é•¿ç¾¤éƒ½åœ¨è½¬${data.source}çš„æ¶ˆæ¯ï¼Œé—®æˆ‘è¦ä¸è¦æŠ¥ï¼ŸğŸ’¡\n\nè¯´å®è¯ï¼Œåˆ«ç„¦è™‘ï¼æ ¸å¿ƒé€»è¾‘æ˜¯ï¼š${data.content}ã€‚\n\næˆ‘çš„å»ºè®®æ˜¯ï¼šé‹å­åˆä¸åˆè„šåªæœ‰è‡ªå·±çŸ¥é“ï¼Œå…ˆæ‹¿å­©å­çš„è¯•å·æ¥åˆ†æï¼Œå†åšå†³å®šï¼`;
            } else {
                teacherShort = `æ¥äº†ï¼${data.tag}ç»ˆäºå®šäº†ï¼ğŸ˜±\n\n${data.source}åˆšåˆšå‘è¯ï¼š${data.content}ã€‚\n\nå„ä½å®¶é•¿ï¼Œé—¹é’Ÿå®šå¥½äº†å—ï¼Ÿè¿™ä¸ªæ—¶é—´ç‚¹éå¸¸å…³é”®ï¼Œåƒä¸‡åˆ«å› ä¸ºä¸€æ—¶ç–å¿½è€½è¯¯å¤§äº‹ï¼`;
            }

            let teacherXhs = '';
            if (isArt) {
                teacherXhs = `ğŸ†˜ è‰ºè€ƒç”Ÿæ€¥æ•‘åŒ…ï¼ç»Ÿè€ƒè€ƒå®Œåˆ«å…‰é¡¾ç€ç©ï¼\n\nåˆšè€ƒå®Œè¯•å¾ˆç´¯æƒ³æ”¾æ¾ï¼Ÿæˆ‘æ‡‚ï¼ä½†åœ¨å¹¿ä¸œï¼Œè‰ºè€ƒ=æ˜“è€ƒï¼Ÿé‚£æ˜¯è€é»„å†äº†ï¼ğŸ˜­\n\nğŸ‘‰ æ‰å¿ƒçš„äº‹å®\nä¸“ä¸šè¯¾å†³å®šä½ èƒ½ä¸èƒ½èµ°ï¼Œæ–‡åŒ–è¯¾å†³å®šä½ èµ°å“ªé‡Œï¼\nå¾ˆå¤šåŒå­¦æ‹¿åˆ°åˆæ ¼è¯æ²¾æ²¾è‡ªå–œï¼Œç»“æœé«˜è€ƒå‡ºåˆ†å‚»çœ¼äº†ï¼Œè¿ææ¡£çº¿éƒ½å¤Ÿä¸ç€ã€‚\n\nğŸ’¡ è¿‡æ¥äººçš„è¡€æ³ªå»ºè®®\n1. åˆ«ç¢°éš¾é¢˜ï¼åˆ«ç¢°éš¾é¢˜ï¼æŠ“åŸºç¡€ï¼\n2. è‹±è¯­å¬åŠ›å£è¯­åˆ«æ”¾å¼ƒï¼Œé‚£æ˜¯é€åˆ†é¢˜ï¼\n3. æ‰¾ä¸ªæ‡‚è‰ºè€ƒç”Ÿçš„è€å¸ˆå¸¦ç€å­¦ï¼Œæ•ˆç‡ç¿»å€ã€‚\n\nä¸æƒ³æœ€åæ—¶åˆ»å“­é¼»å­çš„ï¼Œèµ¶ç´§åŠ¨èµ·æ¥ï¼ğŸ’ª\n\n#è‰ºè€ƒåŠ æ²¹ #æ–‡åŒ–è¯¾ #é¿å‘æŒ‡å— #å¹¿ä¸œé«˜è€ƒ`;
            } else {
                teacherXhs = `ğŸ†˜ å®¶é•¿å¿…çœ‹ï¼${data.tag}æ¶ˆæ¯æ¥äº†ï¼\n\nåˆšæ‰çœ‹åˆ°${data.source}çš„æ¶ˆæ¯ï¼Œå¿ƒé‡ŒçŸ³å¤´ç»ˆäºè½åœ°äº†ï¼ğŸ˜‚\n\nğŸ‘‰ é‡ç‚¹åˆ’ä¸€ä¸‹\n${data.content}\n\nğŸ’­ ç¢ç¢å¿µ\næ¯å¹´éƒ½æœ‰å®¶é•¿å› ä¸ºé”™è¿‡æ—¶é—´èŠ‚ç‚¹åæ‚”ï¼Œè¿™æ¬¡å’±ä»¬åƒä¸‡åˆ«è¸©å‘ï¼\n\nğŸ’¡ å­¦å§ç»™ä½ çš„å»ºè®®\n1. æ‰‹æœºæ—¥å†é©¬ä¸Šè®¾ç½®æé†’â°\n2. èµ„æ–™æå‰å‡†å¤‡å¥½ï¼Œåˆ«ç­‰åˆ°æœ€åä¸€å¤©ğŸ“‚\n3. å¿ƒæ€ç¨³ä½ï¼Œå­©å­æ‰ç¨³å¾—ä½ğŸ’ª\n\næœ‰ä¸æ‡‚çš„éšæ—¶é—®æˆ‘ï¼Œåœ¨çº¿ç­‰ï¼ğŸ‘‹\n\n#åå¸ˆæŒ‡è·¯ #å®¶é•¿å¿…è¯» #${data.tag}`;
            }

            const shortText = config.persona === 'professional' ? professionalShort : teacherShort;
            const xhsText = config.persona === 'professional' ? professionalXhs : teacherXhs;
            
            document.getElementById('coverTitle').innerText = data.title;
            document.getElementById('coverTag').innerText = data.tag;
            document.getElementById('editTitleInput').value = data.title;
            document.getElementById('editTagInput').value = data.tag;
            document.getElementById('captureTarget').className = `title-card-wrapper ${data.bg} transform transition shadow-2xl`;

            const speed = fastMode ? 2 : 10;
            await typeWriter(shortText, shortOutput, speed);
            await typeWriter(xhsText, xhsOutput, speed/2);

            btn.disabled = false;
            btn.innerHTML = '<span><i class="fa-solid fa-sparkles mr-2"></i> é‡æ–°ç”Ÿæˆ</span>';
            
            if(window.innerWidth < 1024 && !fastMode) {
               document.getElementById('resultArea').scrollIntoView({behavior: 'smooth'});
            }
        }

        function typeWriter(text, element, speed) {
            return new Promise(resolve => {
                let i = 0;
                function type() { if (i < text.length) { element.innerHTML += text.charAt(i); i++; setTimeout(type, speed); } else { resolve(); } }
                type();
            });
        }

        function downloadMarkdown(type) {
            const elId = type === 'video' ? 'shortScriptOutput' : 'xhsScriptOutput';
            const content = document.getElementById(elId).innerText;
            const title = document.getElementById('coverTitle').innerText;
            const blob = new Blob([`# ${title}\n\n${content}`], { type: "text/markdown;charset=utf-8" });
            saveAs(blob, `${title}.md`);
        }

        function downloadCover() {
            const captureTarget = document.getElementById('captureTarget');
            const originalTransform = captureTarget.style.transform;
            captureTarget.style.transform = 'none'; 

            html2canvas(captureTarget, { scale: 3, useCORS: true, backgroundColor: null }).then(canvas => {
                canvas.toBlob(blob => saveAs(blob, `${document.getElementById('coverTitle').innerText}.png`));
                captureTarget.style.transform = originalTransform;
            });
        }

        function switchTab(tab) {
            if(tab === 'script') {
                document.getElementById('scriptView').classList.remove('hidden');
                document.getElementById('scriptDownloads').classList.remove('hidden');
                document.getElementById('coverView').classList.add('hidden');
            } else {
                document.getElementById('scriptView').classList.add('hidden');
                document.getElementById('scriptDownloads').classList.add('hidden');
                document.getElementById('coverView').classList.remove('hidden');
            }
        }
        
        switchTab('script');
    </script>
</body>
</html>